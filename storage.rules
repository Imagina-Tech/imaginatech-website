rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // ===========================
    // VERIFICACAO DE ADMIN VIA CUSTOM CLAIMS
    // Custom claim 'admin' e definido automaticamente pela Cloud Function
    // quando um admin e adicionado/ativado na colecao /admins
    // ===========================
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    // Super Admin tem acesso total (fallback por email caso custom claim falhe)
    function isSuperAdmin() {
      return request.auth != null &&
        request.auth.token.email == "3d3printers@gmail.com";
    }

    // Usuario autenticado com email verificado
    function isAuthenticatedAndVerified() {
      return request.auth != null && request.auth.token.email_verified == true;
    }

    // Admin OU Super Admin (atalho usado em todas as regras)
    function isAdminOrSuper() {
      return isAdmin() || isSuperAdmin();
    }

    // Validacao de arquivo: tamanho maximo 10MB e tipos permitidos
    function isValidFile() {
      return request.resource.size < 10 * 1024 * 1024
        && (request.resource.contentType.matches('image/.*')
            || request.resource.contentType.matches('application/pdf')
            || request.resource.contentType.matches('model/.*')
            || request.resource.contentType.matches('application/octet-stream'));
    }

    // Validacao para arquivos 3MF/modelos 3D: ate 100MB
    function isValid3DFile() {
      return request.resource.size < 100 * 1024 * 1024
        && (request.resource.contentType.matches('model/.*')
            || request.resource.contentType.matches('application/octet-stream')
            || request.resource.contentType.matches('application/vnd.ms-package.*'));
    }

    // ===========================
    // ARQUIVOS DE SERVICOS
    // Admins podem ler/escrever, usuarios autenticados podem ler
    // ===========================
    match /services/{serviceId}/{fileName} {
      allow read: if isAuthenticatedAndVerified();
      allow write: if isAdminOrSuper() && isValidFile();
      allow delete: if isAdminOrSuper();
    }

    // ===========================
    // PORTFOLIO (Projetos Publicos)
    // Leitura publica, escrita apenas admins
    // ===========================
    match /portfolio/{fileName} {
      allow read: if true;
      allow write: if isAdminOrSuper() && isValidFile();
      allow delete: if isAdminOrSuper();
    }

    // ===========================
    // ARQUIVOS DE TAREFAS
    // Apenas admins
    // ===========================
    match /tasks/{taskId}/{fileName} {
      allow read: if isAdminOrSuper();
      allow write: if isAdminOrSuper() && isValidFile();
      allow delete: if isAdminOrSuper();
    }

    // ===========================
    // ARQUIVOS DE ESTOQUE (Filamentos e Equipamentos)
    // Apenas admins
    // ===========================
    match /filaments/{fileName} {
      allow read: if isAdminOrSuper();
      allow write: if isAdminOrSuper() && isValidFile();
      allow delete: if isAdminOrSuper();
    }

    match /equipment/{fileName} {
      allow read: if isAdminOrSuper();
      allow write: if isAdminOrSuper() && isValidFile();
      allow delete: if isAdminOrSuper();
    }

    // ===========================
    // ARQUIVOS DE PRODUTOS (Marketplace) - Fotos
    // Apenas admins
    // ===========================
    match /products/{fileName} {
      allow read: if isAdminOrSuper();
      allow write: if isAdminOrSuper() && isValidFile();
      allow delete: if isAdminOrSuper();
    }

    // ===========================
    // ARQUIVOS 3MF DE PRODUTOS (Marketplace)
    // Ate 100MB por arquivo
    // Apenas admins
    // ===========================
    match /products/3mf/{fileName} {
      allow read: if isAdminOrSuper();
      allow write: if isAdminOrSuper() && isValid3DFile();
      allow delete: if isAdminOrSuper();
    }

    // ===========================
    // REGRA PADRAO - BLOQUEAR TUDO NAO ESPECIFICADO
    // Apenas paths especificos acima tem acesso
    // ===========================
    match /{allPaths=**} {
      allow read: if false;
      allow write: if false;
    }
  }
}
